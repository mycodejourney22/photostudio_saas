<!-- app/views/dashboard/index.html.erb -->
<% content_for :title, "Dashboard - #{current_tenant.name}" %>

<div class="min-h-screen bg-gray-50 flex">
  <!-- Sidebar - Desktop -->
  <div class="hidden lg:flex lg:flex-shrink-0">
    <div class="flex flex-col w-64">
      <div class="flex-1 flex flex-col min-h-0 bg-gradient-to-b from-blue-600 to-purple-700">
        <%= render 'shared/sidebar' %>
      </div>
    </div>
  </div>

  <!-- Mobile sidebar overlay -->
  <div class="lg:hidden" data-controller="mobile-navigation">
    <!-- Mobile menu button -->
    <div class="fixed top-4 left-4 z-50">
      <button data-action="mobile-navigation#toggleMenu"
              class="bg-white p-2 rounded-lg shadow-lg text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>

    <!-- Mobile backdrop -->
    <div data-mobile-navigation-target="backdrop"
         data-action="click->mobile-navigation#closeOnBackdrop"
         class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

    <!-- Mobile sidebar -->
    <div data-mobile-navigation-target="menu"
         class="fixed inset-y-0 left-0 z-50 w-64 bg-gradient-to-b from-blue-600 to-purple-700 shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out">
      <%= render 'shared/sidebar' %>
    </div>
  </div>

  <!-- Main content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 flex-shrink-0">
      <div class="px-4 lg:px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex-1 min-w-0 ml-12 lg:ml-0">
            <h1 class="text-xl lg:text-2xl font-bold text-gray-900 truncate">
              Welcome back, <%= current_user.first_name %>!
            </h1>
            <p class="text-sm text-gray-500 mt-1">
              Here's what's happening at <%= current_tenant.name %> today
            </p>
          </div>
          <div class="flex items-center space-x-4">
            <%= link_to new_appointment_path,
                  class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2" do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              <span>New Booking</span>
            <% end %>

            <%= link_to new_customer_path,
                  class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2" do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
              </svg>
              <span>Add Customer</span>
            <% end %>
          </div>
        </div>
      </div>
    </header>

    <!-- Main content area -->
    <main class="flex-1 overflow-y-auto px-4 lg:px-6 py-6">
      <!-- Key Metrics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
        <!-- Today's Sales -->
        <%
          todays_sales = current_tenant.sales.where(sale_date: Date.current.all_day).sum(:total_amount)
          yesterdays_sales = current_tenant.sales.where(sale_date: (Date.current - 1.day).all_day).sum(:total_amount)
          sales_change = todays_sales - yesterdays_sales
        %>
        <%= link_to sales_path, class: "dashboard-stat cursor-pointer hover:shadow-xl transition-shadow block" do %>
          <div class="dashboard-stat-value">‚Ç¶<%= number_with_delimiter(todays_sales) %></div>
          <div class="dashboard-stat-label">Today's Sales</div>
          <div class="flex items-center text-sm mt-2">
            <% if sales_change > 0 %>
              <svg class="w-4 h-4 text-green-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-blue-100">+‚Ç¶<%= number_with_delimiter(sales_change) %> vs yesterday</span>
            <% elsif sales_change < 0 %>
              <svg class="w-4 h-4 text-red-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-blue-100">‚Ç¶<%= number_with_delimiter(sales_change) %> vs yesterday</span>
            <% else %>
              <span class="text-blue-100">Same as yesterday</span>
            <% end %>
          </div>
        <% end %>

        <!-- Active Photoshoots -->
        <%
          todays_photoshoots = current_tenant.appointments
                                           .where(scheduled_at: Date.current.all_day)
                                           .where("assigned_photographer_id IS NOT NULL OR assigned_editor_id IS NOT NULL")
                                           .count
          yesterdays_photoshoots = current_tenant.appointments
                                               .where(scheduled_at: (Date.current - 1.day).all_day)
                                               .where("assigned_photographer_id IS NOT NULL OR assigned_editor_id IS NOT NULL")
                                               .count
          photoshoots_change = todays_photoshoots - yesterdays_photoshoots
        %>
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg p-4 lg:p-6 shadow-lg">
          <div class="dashboard-stat-value"><%= todays_photoshoots %></div>
          <div class="dashboard-stat-label">Active Photoshoots</div>
          <div class="flex items-center text-sm mt-2">
            <% if photoshoots_change > 0 %>
              <svg class="w-4 h-4 text-green-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-purple-100">+<%= photoshoots_change %> from yesterday</span>
            <% elsif photoshoots_change < 0 %>
              <svg class="w-4 h-4 text-red-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-purple-100"><%= photoshoots_change %> from yesterday</span>
            <% else %>
              <span class="text-purple-100">Same as yesterday</span>
            <% end %>
          </div>
        </div>

        <!-- Today's Bookings -->
        <%
          todays_bookings = current_tenant.appointments.where(scheduled_at: Date.current.all_day).count
          yesterdays_bookings = current_tenant.appointments.where(scheduled_at: (Date.current - 1.day).all_day).count
          bookings_change = todays_bookings - yesterdays_bookings
        %>
        <div class="dashboard-stat">
          <div class="dashboard-stat-value"><%= todays_bookings %></div>
          <div class="dashboard-stat-label">Today's Bookings</div>
          <div class="flex items-center text-sm mt-2">
            <% if bookings_change > 0 %>
              <svg class="w-4 h-4 text-green-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-blue-100">+<%= bookings_change %> from yesterday</span>
            <% elsif bookings_change < 0 %>
              <svg class="w-4 h-4 text-red-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-blue-100"><%= bookings_change %> from yesterday</span>
            <% else %>
              <span class="text-blue-100">Same as yesterday</span>
            <% end %>
          </div>
        </div>

        <!-- Today's Expenses -->
        <%
          todays_expenses = current_tenant.expenses.where(expense_date: Date.current.all_day).sum(:amount)
          yesterdays_expenses = current_tenant.expenses.where(expense_date: (Date.current - 1.day).all_day).sum(:amount)
          expenses_change = todays_expenses - yesterdays_expenses
        %>
        <%= link_to expenses_path, class: "bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg p-4 lg:p-6 shadow-lg cursor-pointer hover:shadow-xl transition-shadow block" do %>
          <div class="dashboard-stat-value">‚Ç¶<%= number_with_delimiter(todays_expenses) %></div>
          <div class="dashboard-stat-label">Today's Expenses</div>
          <div class="flex items-center text-sm mt-2">
            <% if expenses_change > 0 %>
              <svg class="w-4 h-4 text-red-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-orange-100">+‚Ç¶<%= number_with_delimiter(expenses_change) %> vs yesterday</span>
            <% elsif expenses_change < 0 %>
              <svg class="w-4 h-4 text-green-200 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-orange-100">-‚Ç¶<%= number_with_delimiter(expenses_change.abs) %> vs yesterday</span>
            <% else %>
              <span class="text-orange-100">Same as yesterday</span>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Content Grid -->
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <!-- Today's Schedule (2/3 width) -->
        <div class="xl:col-span-2 dashboard-card">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">Today's Schedule</h2>
            <%= link_to appointments_path, class: "text-blue-600 hover:text-blue-700 text-sm font-medium" do %>
              View All
            <% end %>
          </div>

          <!-- Schedule Items -->
          <%
            todays_appointments = current_tenant.appointments
                                               .where(scheduled_at: Date.current.all_day)
                                               .includes(:customer, :assigned_photographer, :assigned_editor, :service_tier)
                                               .order(:scheduled_at)
          %>

          <% if todays_appointments.any? %>
            <div class="space-y-4">
              <% todays_appointments.each do |appointment| %>
                <%
                  # Determine appointment type and styling
                  has_photographer = appointment.assigned_photographer.present?
                  has_editor = appointment.assigned_editor.present?
                  is_photoshoot = has_photographer || has_editor

                  # Set border and background colors based on status and assignments
                  if appointment.completed?
                    border_class = "border-blue-500"
                    bg_class = "bg-blue-50 hover:bg-blue-100"
                  elsif is_photoshoot
                    border_class = "border-purple-500"
                    bg_class = "bg-purple-50 hover:bg-purple-100"
                  elsif appointment.confirmed?
                    border_class = "border-green-500"
                    bg_class = "bg-green-50 hover:bg-green-100"
                  else
                    border_class = "border-yellow-500"
                    bg_class = "bg-yellow-50 hover:bg-yellow-100"
                  end
                %>

                <div class="flex items-center justify-between p-4 rounded-lg border-l-4 <%= border_class %> <%= bg_class %> transition-colors">
                  <div class="flex items-center space-x-4">
                    <div class="text-sm font-semibold text-gray-900 w-20">
                      <%= appointment.scheduled_at.strftime("%I:%M %p") %>
                    </div>
                    <div class="flex-1">
                      <div class="text-sm font-medium text-gray-900">
                        <%= appointment.customer.first_name %> <%= appointment.customer.last_name %>
                      </div>
                      <div class="text-xs text-gray-500">
                        <%= appointment.service_tier&.name || appointment.session_type&.humanize || 'Appointment' %> ‚Ä¢
                        <%= appointment.status.humanize %>
                      </div>

                      <!-- Staff assignments -->
                      <div class="mt-1">
                        <% if has_photographer %>
                          <div class="text-xs text-purple-600 font-medium">
                            üì∑ <%= appointment.assigned_photographer.first_name %> <%= appointment.assigned_photographer.last_name %>
                          </div>
                        <% end %>

                        <% if has_editor %>
                          <div class="text-xs text-blue-600 font-medium">
                            ‚úÇÔ∏è <%= appointment.assigned_editor.first_name %> <%= appointment.assigned_editor.last_name %>
                          </div>
                        <% end %>

                        <% if !has_photographer && !has_editor && !appointment.completed? %>
                          <div class="text-xs text-amber-600 font-medium">
                            ‚ö† Needs staff assignment
                          </div>
                        <% end %>

                        <% if appointment.completed? %>
                          <div class="text-xs text-green-600 font-medium">
                            ‚úÖ Completed
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                  <div class="text-sm font-semibold text-green-600">
                    ‚Ç¶<%= number_with_delimiter(appointment.price) %>
                  </div>
                </div>
              <% end %>
            </div>

            <!-- Summary Stats -->
            <%
              with_photographers = todays_appointments.count { |a| a.assigned_photographer.present? }
              with_editors = todays_appointments.count { |a| a.assigned_editor.present? }
              needs_assignment = todays_appointments.count { |a| a.assigned_photographer.blank? && a.assigned_editor.blank? && !a.completed? }
            %>
            <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-gray-200">
              <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-900"><%= with_photographers %></div>
                <div class="text-xs text-gray-500 uppercase tracking-wide">With Photographers</div>
              </div>
              <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-900"><%= needs_assignment %></div>
                <div class="text-xs text-gray-500 uppercase tracking-wide">Needs Assignment</div>
              </div>
            </div>
          <% else %>
            <!-- Empty state -->
            <div class="text-center py-12">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0V7a2 2 0 012-2h4a2 2 0 012 2v0m-6 0h6"/>
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">No appointments today</h3>
              <p class="mt-1 text-sm text-gray-500">Get started by creating a new booking.</p>
              <div class="mt-6">
                <%= link_to new_appointment_path, class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" do %>
                  <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                  </svg>
                  New Booking
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Quick Stats (1/3 width) -->
        <div class="dashboard-card">
          <h2 class="text-xl font-semibold text-gray-900 mb-6">Quick Stats</h2>

          <!-- Quick Stats Usage Bars -->
          <%
            # Get actual usage data
            current_bookings = current_tenant.appointments.where(created_at: Date.current.beginning_of_month..Date.current.end_of_month).count
            booking_limit = 500 # You might want to get this from tenant plan
            booking_percentage = (current_bookings.to_f / booking_limit * 100).round(1)

            # Storage usage - using approximate calculation based on file attachments
            # You can implement actual storage calculation based on your file storage system
            current_storage = 0 # Replace with actual storage calculation
            storage_limit_gb = 46.6 # Get from tenant plan
            storage_percentage = storage_limit_gb > 0 ? (current_storage / (storage_limit_gb * 1_000_000_000) * 100).round(1) : 0

            # Team members
            current_team_members = current_tenant.staff_members.where(active: true).count
            team_limit = 10 # Get from tenant plan
            team_percentage = (current_team_members.to_f / team_limit * 100).round(1)
          %>

          <!-- Bookings Usage -->
          <div class="mb-6">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-gray-600">Monthly Bookings</span>
              <span class="font-medium"><%= current_bookings %>/<%= booking_limit %></span>
            </div>
            <div class="bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: <%= [booking_percentage, 100].min %>%"></div>
            </div>
          </div>

          <!-- Storage Usage -->
          <div class="mb-6">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-gray-600">Storage Used</span>
              <span class="font-medium">
                <% if current_storage > 0 %>
                  <%= number_to_human_size(current_storage) %>/<%= storage_limit_gb %> GB
                <% else %>
                  0 Bytes/<%= storage_limit_gb %> GB
                <% end %>
              </span>
            </div>
            <div class="bg-gray-200 rounded-full h-2">
              <div class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: <%= [storage_percentage, 100].min %>%"></div>
            </div>
          </div>

          <!-- Team Members -->
          <div class="mb-6">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-gray-600">Team Members</span>
              <span class="font-medium"><%= current_team_members %>/<%= team_limit %></span>
            </div>
            <div class="bg-gray-200 rounded-full h-2">
              <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: <%= [team_percentage, 100].min %>%"></div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="pt-4 border-t border-gray-200">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Quick Actions</h3>
            <div class="grid grid-cols-2 gap-3">
              <%= link_to customers_path,
                    class: "p-3 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition-colors" do %>
                <div class="text-blue-600 font-medium text-sm">View Customers</div>
              <% end %>

              <%= link_to appointments_path,
                    class: "p-3 bg-green-50 rounded-lg text-center hover:bg-green-100 transition-colors" do %>
                <div class="text-green-600 font-medium text-sm">All Bookings</div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Breakdowns -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        <!-- Sales Breakdown -->
        <div class="dashboard-card" id="sales-breakdown">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Today's Sales Breakdown</h2>
            <% if respond_to?(:analytics_revenue_path) %>
              <%= link_to analytics_revenue_path, class: "text-blue-600 hover:text-blue-800 text-sm font-medium" do %>
                Full Sales Report
              <% end %>
            <% end %>
          </div>

          <%
            # Get today's sales and organize by category
            todays_sales = current_tenant.sales.where(sale_date: Date.current.all_day).includes(:sale_items, sale_items: { service_tier: :service_package })

            # Group sales by service category or type
            sales_breakdown = {}
            total_todays_sales = 0

            todays_sales.each do |sale|
              sale.sale_items.each do |item|
                # Try to get category from service package, fallback to item type or name
                category = if item.service_tier&.service_package&.category.present?
                            item.service_tier.service_package.category.humanize
                          elsif item.item_type.present?
                            item.item_type.humanize
                          else
                            'Other Services'
                          end

                sales_breakdown[category] ||= { amount: 0, count: 0 }
                sales_breakdown[category][:amount] += item.total_price
                sales_breakdown[category][:count] += item.quantity
                total_todays_sales += item.total_price
              end
            end
          %>

          <div class="space-y-4">
            <% if sales_breakdown.any? %>
              <% sales_breakdown.each do |category, data| %>
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                  <div>
                    <div class="text-sm font-medium text-gray-900"><%= category %></div>
                    <div class="text-xs text-gray-500"><%= pluralize(data[:count], 'item') %></div>
                  </div>
                  <div class="text-sm font-bold text-green-600">‚Ç¶<%= number_with_delimiter(data[:amount]) %></div>
                </div>
              <% end %>

              <div class="pt-4 border-t-2 border-gray-200">
                <div class="flex justify-between items-center">
                  <div>
                    <div class="text-base font-semibold text-gray-900">Total Sales</div>
                    <div class="text-sm text-gray-500"><%= pluralize(todays_sales.count, 'transaction') %></div>
                  </div>
                  <div class="text-lg font-bold text-green-600">‚Ç¶<%= number_with_delimiter(total_todays_sales) %></div>
                </div>
              </div>
            <% else %>
              <div class="text-center py-8">
                <div class="text-gray-500">No sales recorded today</div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Expenses Breakdown -->
        <div class="dashboard-card" id="expenses-breakdown">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Today's Expenses Breakdown</h2>
            <%= link_to expenses_path, class: "text-blue-600 hover:text-blue-800 text-sm font-medium" do %>
              Full Expense Report
            <% end %>
          </div>

          <%
            todays_expenses_by_category = current_tenant.expenses
                                                       .where(expense_date: Date.current.all_day)
                                                       .joins(:expense_category)
                                                       .group('expense_categories.name')
                                                       .sum(:amount)

            todays_expenses_count_by_category = current_tenant.expenses
                                                             .where(expense_date: Date.current.all_day)
                                                             .joins(:expense_category)
                                                             .group('expense_categories.name')
                                                             .count

            total_todays_expenses = todays_expenses_by_category.values.sum
          %>

          <div class="space-y-4">
            <% if todays_expenses_by_category.any? %>
              <% todays_expenses_by_category.each do |category, amount| %>
                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                  <div>
                    <div class="text-sm font-medium text-gray-900"><%= category %></div>
                    <div class="text-xs text-gray-500"><%= pluralize(todays_expenses_count_by_category[category] || 0, 'expense') %></div>
                  </div>
                  <div class="text-sm font-bold text-red-600">-‚Ç¶<%= number_with_delimiter(amount) %></div>
                </div>
              <% end %>

              <div class="pt-4 border-t-2 border-gray-200">
                <div class="flex justify-between items-center">
                  <div>
                    <div class="text-base font-semibold text-gray-900">Total Expenses</div>
                    <div class="text-sm text-gray-500"><%= pluralize(todays_expenses_by_category.values.sum, 'transaction') %> today</div>
                  </div>
                  <div class="text-lg font-bold text-red-600">-‚Ç¶<%= number_with_delimiter(total_todays_expenses) %></div>
                </div>
              </div>
            <% else %>
              <div class="text-center py-8">
                <div class="text-gray-500">No expenses recorded today</div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Operations Status -->
      <div class="dashboard-card mt-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-6">Operations Status</h2>

        <%
          # Calculate real operational metrics
          total_appointment_slots_today = 8 # You can make this configurable per studio location
          todays_booking_count = current_tenant.appointments.where(scheduled_at: Date.current.all_day).count
          booking_capacity = total_appointment_slots_today > 0 ? ((todays_booking_count.to_f / total_appointment_slots_today) * 100).round(0) : 0

          # Average session length from completed appointments
          completed_appointments_today = current_tenant.appointments
                                                       .where(scheduled_at: Date.current.all_day, status: 'completed')
          avg_session_length = completed_appointments_today.any? ?
                              (completed_appointments_today.average(:duration_minutes) / 60.0).round(1) : 0

          # Customer satisfaction - you might want to implement a rating system
          # For now, using a placeholder calculation based on completed vs cancelled appointments
          total_recent_appointments = current_tenant.appointments.where(scheduled_at: 1.month.ago..Date.current).count
          cancelled_appointments = current_tenant.appointments.where(scheduled_at: 1.month.ago..Date.current, status: 'cancelled').count
          satisfaction = total_recent_appointments > 0 ?
                        (((total_recent_appointments - cancelled_appointments).to_f / total_recent_appointments) * 100).round(0) : 0

          # Overdue deliveries - appointments that are completed but past expected delivery
          overdue_deliveries = current_tenant.appointments
                                           .where(status: 'completed')
                                           .where('scheduled_at < ?', 2.weeks.ago) # Assuming 2 week delivery window
                                           .where('delivery_date IS NULL OR delivery_date < ?', Date.current)
                                           .count
        %>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-<%= booking_capacity >= 80 ? 'green' : booking_capacity >= 60 ? 'yellow' : 'red' %>-600 mb-2">
              <%= booking_capacity %>%
            </div>
            <div class="text-sm text-gray-500 uppercase tracking-wide">Booking Capacity</div>
          </div>

          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600 mb-2">
              <%= avg_session_length > 0 ? "#{avg_session_length}hrs" : "0hrs" %>
            </div>
            <div class="text-sm text-gray-500 uppercase tracking-wide">Avg Session Length</div>
          </div>

          <div class="text-center">
            <div class="text-3xl font-bold text-<%= satisfaction >= 90 ? 'green' : satisfaction >= 80 ? 'yellow' : 'red' %>-600 mb-2">
              <%= satisfaction %>%
            </div>
            <div class="text-sm text-gray-500 uppercase tracking-wide">Customer Satisfaction</div>
          </div>

          <div class="text-center">
            <div class="text-3xl font-bold text-<%= overdue_deliveries > 0 ? 'red' : 'green' %>-600 mb-2">
              <%= overdue_deliveries %>
            </div>
            <div class="text-sm text-gray-500 uppercase tracking-wide">Overdue Deliveries</div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
